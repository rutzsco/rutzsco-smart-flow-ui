@page "/voicechat"
@inject IJSRuntime JS

<PageTitle>Voice Chat</PageTitle>

<style>
    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    @@keyframes wave {
        0%, 100% {
            transform: scaleY(0.5);
        }
        50% {
            transform: scaleY(1);
        }
    }

    .listening-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        height: 40px;
    }

    .listening-bar {
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #f44336 0%, #e91e63 100%);
        border-radius: 2px;
        animation: wave 1s ease-in-out infinite;
    }

    .listening-bar:nth-child(1) { animation-delay: 0s; }
    .listening-bar:nth-child(2) { animation-delay: 0.1s; }
    .listening-bar:nth-child(3) { animation-delay: 0.2s; }
    .listening-bar:nth-child(4) { animation-delay: 0.3s; }
    .listening-bar:nth-child(5) { animation-delay: 0.2s; }
    .listening-bar:nth-child(6) { animation-delay: 0.1s; }

    .mic-pulse {
        animation: pulse 1.5s ease-in-out infinite;
    }

    .status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .conversation-card {
        border-left: 4px solid var(--mud-palette-primary);
    }

    .message-user {
        background: linear-gradient(135deg, rgba(25, 118, 210, 0.08) 0%, rgba(25, 118, 210, 0.04) 100%);
        border-left: 3px solid var(--mud-palette-primary);
        border-radius: 8px;
    }

    .message-agent {
        background: linear-gradient(135deg, rgba(156, 39, 176, 0.08) 0%, rgba(156, 39, 176, 0.04) 100%);
        border-left: 3px solid var(--mud-palette-secondary);
        border-radius: 8px;
    }

    .control-button {
        min-width: 160px;
        height: 56px;
        font-size: 1rem;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease;
    }

    .control-button:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" Class="text-center mb-4">
            <MudText Typo="Typo.h4">Voice Chat</MudText>
        </MudItem>

        @if (_errorMessage != null)
        {
            <MudItem xs="12" lg="10">
                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4" CloseIconClicked="@(() => _errorMessage = null)">
                    @_errorMessage
                </MudAlert>
            </MudItem>
        }

        <MudItem xs="12" lg="10">
            <MudPaper Elevation="8" Class="pa-6" Style="border-radius: 16px;">
                <MudStack Spacing="4">
                    
                    <!-- Status Display with Gradient -->
                    <MudCard Elevation="0" Class="status-card" Style="border-radius: 12px;">
                        <MudCardContent Class="pa-4">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.caption" Style="opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">Status</MudText>
                                    <MudChip T="string" 
                                             Color="Color.Surface" 
                                             Size="Size.Medium"
                                             Style="font-weight: 600;">
                                        @_connectionStatus
                                    </MudChip>
                                </MudStack>
                                @if (_isConnected)
                                {
                                    <MudStack Spacing="1" Style="text-align: right;">
                                        <MudText Typo="Typo.caption" Style="opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">Session Time</MudText>
                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">@_sessionDuration</MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- Listening Indicator -->
                    @if (_isListening)
                    {
                        <MudCard Elevation="0" Outlined="true" Style="border-radius: 12px; border: 2px solid #f44336;">
                            <MudCardContent Class="pa-4 text-center">
                                <MudStack Spacing="3" AlignItems="AlignItems.Center">
                                    <div class="listening-indicator">
                                        <div class="listening-bar"></div>
                                        <div class="listening-bar"></div>
                                        <div class="listening-bar"></div>
                                        <div class="listening-bar"></div>
                                        <div class="listening-bar"></div>
                                        <div class="listening-bar"></div>
                                    </div>
                                    <MudText Typo="Typo.body1" Style="font-weight: 600; color: #f44336;">
                                        <MudIcon Icon="@Icons.Material.Filled.Mic" Size="Size.Small" Class="mr-1" />
                                        Listening... Speak now
                                    </MudText>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    }

                    <!-- Control Buttons -->
                    <MudStack Row="true" Justify="Justify.Center" Spacing="3" Class="mt-4">
                        @if (!_isConnected)
                        {
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       Size="Size.Large"
                                       Class="control-button"
                                       StartIcon="@Icons.Material.Filled.PlayArrow"
                                       OnClick="StartVoiceChatAsync"
                                       Disabled="@_isConnecting">
                                @(_isConnecting ? "Connecting..." : "Start Voice Chat")
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Filled" 
                                       Color="@(_isListening ? Color.Error : Color.Success)" 
                                       Size="Size.Large"
                                       Class="@(_isListening ? "control-button mic-pulse" : "control-button")"
                                       StartIcon="@(_isListening ? Icons.Material.Filled.Stop : Icons.Material.Filled.Mic)"
                                       OnClick="ToggleListeningAsync">
                                @(_isListening ? "Stop & Send" : "Start Listening")
                            </MudButton>

                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Error" 
                                       Size="Size.Large"
                                       Class="control-button"
                                       StartIcon="@Icons.Material.Filled.StopCircle"
                                       OnClick="StopVoiceChatAsync">
                                End Session
                            </MudButton>
                        }
                    </MudStack>

                    <!-- Transcript Display -->
                    @if (_transcript.Any())
                    {
                        <MudCard Elevation="0" Outlined="true" Class="conversation-card mt-4" Style="border-radius: 12px;">
                            <MudCardHeader Style="background: rgba(0,0,0,0.02);">
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                        <MudIcon Icon="@Icons.Material.Filled.Forum" Class="mr-2" Color="Color.Primary" />
                                        Conversation
                                    </MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudTooltip Text="Clear conversation">
                                        <MudIconButton Icon="@Icons.Material.Filled.Clear" 
                                                       Color="Color.Default" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => _transcript.Clear())" />
                                    </MudTooltip>
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent Style="padding: 16px;">
                                <MudStack Spacing="3" Style="max-height: 500px; overflow-y: auto;">
                                    @foreach (var message in _transcript)
                                    {
                                        <MudPaper Elevation="0" 
                                                  Class="@(message.IsUser ? "message-user pa-3" : "message-agent pa-3")">
                                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                                                <MudAvatar Color="@(message.IsUser ? Color.Primary : Color.Secondary)" 
                                                           Size="Size.Small">
                                                    <MudIcon Icon="@(message.IsUser ? Icons.Material.Filled.Person : Icons.Material.Filled.SmartToy)" />
                                                </MudAvatar>
                                                <MudStack Spacing="1" Style="flex: 1;">
                                                    <MudText Typo="Typo.caption" 
                                                             Color="Color.Secondary"
                                                             Style="font-weight: 600;">
                                                        @(message.IsUser ? "You" : "AI Agent") 
                                                        <span style="opacity: 0.6;">· @message.Timestamp.ToString("HH:mm:ss")</span>
                                                    </MudText>
                                                    <MudText Typo="Typo.body1" Style="line-height: 1.6;">@message.Text</MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudPaper>
                                    }
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    }
                    else if (_isConnected)
                    {
                        <MudPaper Elevation="0" Class="pa-6 text-center" Style="border: 2px dashed rgba(0,0,0,0.1); border-radius: 12px;">
                            <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Large" Color="Color.Secondary" Class="mb-2" />
                            <MudText Typo="Typo.body1" Color="Color.Secondary">
                                Click <strong>Start Listening</strong> to begin your conversation
                            </MudText>
                        </MudPaper>
                    }

                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>
