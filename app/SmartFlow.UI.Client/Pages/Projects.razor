@page "/projects"

<PageTitle>Project Management</PageTitle>

<MudGrid>
    <!-- Header Section -->
    <MudItem xs="12">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-4">
            <MudText Typo="Typo.h5">Project Management</MudText>
            <MudSpacer />
            
            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                           Color="Color.Primary" 
                           Variant="Variant.Filled"
                           OnClick="ShowCreateProjectForm"
                           Title="Create Project" />
        </MudStack>
    </MudItem>

    <!-- Create/Edit Forms Section -->
    <MudItem xs="12">
        @if (_showCreateProjectForm)
        {
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.CreateNewFolder" Class="mr-2" />
                    Create New Project
                </MudText>
                <MudForm @ref="_createProjectForm" @bind-IsValid="_createProjectFormValid">
                    <MudTextField @bind-Value="_newProjectName" 
                                  Label="Project Name" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Project name is required"
                                  Validation="@(new Func<string, string>(ValidateProjectName))"
                                  Immediate="true"
                                  HelperText="Enter a unique name for the project. Use lowercase letters, numbers, and hyphens only."
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_newProjectType" 
                                  Label="Type (Optional)" 
                                  Variant="Variant.Outlined"
                                  HelperText="Specify the type or category of this project (e.g., Research, Analysis, Development)"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_newProjectDescription" 
                                  Label="Description (Optional)" 
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  HelperText="Provide a brief description of what this project contains"
                                  Class="mb-3" />
                </MudForm>
                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton OnClick="CancelCreateProject" 
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="CreateProjectAsync"
                               StartIcon="@Icons.Material.Filled.Check"
                               Disabled="@(!_createProjectFormValid || string.IsNullOrWhiteSpace(_newProjectName))">
                        Create Project
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        @if (_showEditMetadataForm)
        {
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
                    Edit Project Metadata: @_selectedProject
                </MudText>
                <MudForm>
                    <MudTextField @bind-Value="_editProjectType" 
                                  Label="Type (Optional)" 
                                  Variant="Variant.Outlined"
                                  HelperText="Specify the type or category of this project (e.g., Research, Analysis, Development)"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_editProjectDescription" 
                                  Label="Description (Optional)" 
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  HelperText="Provide a brief description of what this project contains"
                                  Class="mb-3" />
                </MudForm>
                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton OnClick="CancelEditMetadata" 
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="UpdateProjectMetadataAsync"
                               StartIcon="@Icons.Material.Filled.Save">
                        Save Changes
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        @if (_showUploadSection)
        {
            <FileUploadSection TargetName="@_selectedProject"
                             MaxIndividualFileSize="MaxIndividualFileSize"
                             SelectedFiles="_fileUploads"
                             IsUploading="_isUploadingDocuments"
                             OnClose="@(() => _showUploadSection = false)"
                             OnUpload="SubmitFilesForUploadAsync" />
        }
    </MudItem>

    <!-- Projects List Section (Master) - Connected to Details -->
    <MudItem xs="12">
        <MudPaper Elevation="3" Style="border-radius: 4px 4px 0 0;">
            <MudToolBar Dense="true" Style="border-bottom: 1px solid var(--mud-palette-divider);">
                <MudTextField @bind-Value="_projectFilter" 
                              Placeholder="Find..." 
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              IconSize="Size.Small"
                              Margin="Margin.Dense"
                              Immediate="true"
                              DebounceInterval="300"
                              Variant="Variant.Outlined"
                              Style="max-width: 300px;">
                </MudTextField>
                <MudSpacer />
                @if (_isLoadingProjects)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-3" />
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="mr-3">
                        @_projects.Count project@(_projects.Count != 1 ? "s" : "")
                    </MudChip>
                }
                
                @if (!string.IsNullOrEmpty(_selectedProject))
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Color="Color.Default" 
                                   Size="Size.Small"
                                   OnClick="ShowEditMetadataForm"
                                   Title="Edit Project Metadata" />
                    
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Color="Color.Default" 
                                   Size="Size.Small"
                                   OnClick="ShowDeleteProjectDialogAsync"
                                   Title="Delete Project"
                                   Class="mr-2" />
                }
                
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                               OnClick="LoadProjectsAsync" 
                               Size="Size.Small"
                               Title="Refresh project list" />
            </MudToolBar>
            
            @if (!_projects.Any() && !_isLoadingProjects)
            {
                <MudAlert Severity="Severity.Info" Class="ma-4">No projects found. Create your first project to get started.</MudAlert>
            }
            else if (_projects.Any())
            {
                <div style="max-height: 400px; overflow-y: auto;">
                    <MudTable Items="@_projects" 
                              Dense="true" 
                              Hover="true" 
                              Bordered="false" 
                              Striped="true"
                              Filter="OnProjectFilter"
                              SelectedItem="_selectedProjectInfo"
                              SelectedItemChanged="@((CollectionInfo? p) => OnProjectSelectionChangedAsync(p))"
                              Elevation="0"
                              Class="project-table">
                        <HeaderContent>
                            <MudTh Style="width: 40%;"><MudTableSortLabel SortBy="new Func<CollectionInfo, object>(x => x.Name)">Project Name</MudTableSortLabel></MudTh>
                            <MudTh Style="width: 15%;"><MudTableSortLabel SortBy="new Func<CollectionInfo, object>(x => x.Type ?? string.Empty)">Type</MudTableSortLabel></MudTh>
                            <MudTh Style="width: 45%;">Description</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.Name</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Type">
                                @if (!string.IsNullOrWhiteSpace(context.Type))
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Style="text-transform: uppercase;">
                                        @context.Type
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Description">
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Style="white-space: normal;">
                                    @(string.IsNullOrWhiteSpace(context.Description) ? "-" : context.Description)
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>
                
                <MudDivider />
                
                <div class="pa-2" style="background-color: var(--mud-palette-background-grey);">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Showing @_filteredProjectCount of @_projects.Count project@(_projects.Count != 1 ? "s" : "")
                    </MudText>
                </div>
            }
        </MudPaper>

        <!-- Project Details Section (Detail Panel) - Connected to List -->
        @if (!string.IsNullOrEmpty(_selectedProject))
        {
            <MudPaper Elevation="3" Style="border-radius: 0 0 4px 4px; margin-top: 0; border-top: 2px solid var(--mud-palette-primary);">
                <MudToolBar Dense="true" Style="background-color: var(--mud-palette-primary); color: white; border-bottom: 1px solid var(--mud-palette-divider);">
                    <MudTextField @bind-Value="@_filter" 
                                  Placeholder="Find..." 
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Small"
                                  Margin="Margin.Dense"
                                  DebounceInterval="300"
                                  Variant="Variant.Outlined"
                                  Style="max-width: 300px; background-color: rgba(255,255,255,0.9);">
                    </MudTextField>
                    
                    <MudSpacer />
                    
                    @if (_selectedProjectInfo != null && !string.IsNullOrWhiteSpace(_selectedProjectInfo.Type))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Style="text-transform: uppercase; margin-right: 8px;">
                            @_selectedProjectInfo.Type
                        </MudChip>
                    }
                    
                    <MudChip T="string" Size="Size.Small" Style="background-color: rgba(255,255,255,0.2); color: white; margin-right: 8px;">
                        @_projectFiles.Count file@(_projectFiles.Count != 1 ? "s" : "")
                    </MudChip>
                    
                    <MudButton StartIcon="@Icons.Material.Filled.Upload"
                               Color="Color.Inherit"
                               Variant="Variant.Text"
                               Size="Size.Small"
                               OnClick="@(() => _showUploadSection = true)"
                               Class="mr-2">
                        Upload
                    </MudButton>
                    
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                  OnClick="RefreshAsync" 
                                  Size="Size.Small"
                                  Color="Color.Inherit"
                                  Title="Refresh file list" />
                </MudToolBar>

                @if (_selectedProjectInfo != null && !string.IsNullOrWhiteSpace(_selectedProjectInfo.Description))
                {
                    <MudAlert Severity="Severity.Info" Dense="true" Class="ma-0" Style="border-radius: 0;">
                        @_selectedProjectInfo.Description
                    </MudAlert>
                }

                <div class="pa-4">
                    <!-- Files Table -->
                    <MudTable Items="@_projectFiles" 
                              Dense="true" 
                              Hover="true" 
                              Bordered="true" 
                              FixedHeader="true" 
                              Filter="OnFileFilter" 
                              Elevation="0">
                        <HeaderContent>
                            <MudTh><MudTableSortLabel SortBy="new Func<ContainerFileInfo, object>(x => x.FileName)">File Name</MudTableSortLabel></MudTh>
                            <MudTh Style="width: 200px;">Processing Files</MudTh>
                            <MudTh Style="text-align: center; width: 200px;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    @if (CanViewFile(context.FileName))
                                    {
                                        <MudTooltip Text="View file">
                                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                           Color="Color.Info"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await ViewFileAsync(context.FileName, false))" />
                                        </MudTooltip>
                                    }
                                    <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" />
                                    <MudText>@context.FileName</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Processing Files">
                                @if (context.ProcessingFiles.Any())
                                {
                                    <MudStack Spacing="1">
                                        @foreach (var processingFile in context.ProcessingFiles)
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Description">
                                                    @Path.GetFileName(processingFile)
                                                </MudChip>
                                                @if (CanViewFile(processingFile))
                                                {
                                                    <MudTooltip Text="View file">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                                       Color="Color.Info"
                                                                       Size="Size.Small"
                                                                       OnClick="@(async () => await ViewFileAsync(processingFile, true))" />
                                                    </MudTooltip>
                                                }
                                            </MudStack>
                                        }
                                    </MudStack>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Default">
                                        <em>None</em>
                                    </MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Actions" Style="text-align: center;">
                                <MudStack Row="true" Justify="Justify.Center" Spacing="1">
                                    @if (_processingFiles.Contains(context.FileName))
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    }
                                    else if (_deletingFiles.Contains(context.FileName))
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Error" />
                                    }
                                    else
                                    {
                                        <MudTooltip Text="Process document layout">
                                            <MudIconButton Icon="@Icons.Material.Filled.AutoFixHigh"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await ProcessDocumentLayoutAsync(context.FileName))"
                                                           Title="Process Layout" />
                                        </MudTooltip>
                                        <MudTooltip Text="Delete file">
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Color="Color.Error"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await DeleteFileAsync(context.FileName))"
                                                           Title="Delete File" />
                                        </MudTooltip>
                                    }
                                </MudStack>
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                        </PagerContent>
                    </MudTable>
                </div>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

<style>
    .project-table .mud-table-row.mud-selected {
        background-color: var(--mud-palette-action-default-hover) !important;
    }
    
    .project-table .mud-table-row.mud-selected:hover {
        background-color: var(--mud-palette-action-default-hover) !important;
    }
    
    .project-table .mud-table-row {
        cursor: pointer;
    }
</style>
