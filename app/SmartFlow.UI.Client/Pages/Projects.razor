@page "/projects"

<PageTitle>Project Management</PageTitle>

<MudGrid>
    <MudItem xs="12">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-4">
            <MudText Typo="Typo.h5">Project Management</MudText>
            <MudSpacer />
            
            @if (_isLoadingProjects)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                <MudText>Loading projects...</MudText>
            }
            else if (_projects.Any())
            {
                @if (!string.IsNullOrEmpty(_selectedProject))
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_projectFiles.Count file@(_projectFiles.Count != 1 ? "s" : "")</MudChip>
                    
                    @if (_selectedProjectInfo != null && !string.IsNullOrWhiteSpace(_selectedProjectInfo.Type))
                    {
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Color="Color.Info" 
                                 Icon="@Icons.Material.Filled.Label"
                                 Style="text-transform: uppercase;">
                            @_selectedProjectInfo.Type
                        </MudChip>
                    }
                }
                
                <MudMenu Label="@(_selectedProject ?? "Select Project")" Color="Color.Primary">
                    <ActivatorContent>
                        <MudButton Color="Color.Primary" 
                                   Variant="Variant.Outlined" 
                                   StartIcon="@Icons.Material.Filled.Folder" 
                                   EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                            @(_selectedProject ?? "Select Project")
                        </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                        @foreach (var project in _projects)
                        {
                            <MudMenuItem OnClick="@(async () => await SelectProjectAsync(project.Name))">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1">@project.Name</MudText>
                                    @if (!string.IsNullOrWhiteSpace(project.Type))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">Type: @project.Type</MudText>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(project.Description))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Default">@project.Description</MudText>
                                    }
                                </MudStack>
                            </MudMenuItem>
                        }
                    </ChildContent>
                </MudMenu>
            }
            
            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                           Color="Color.Primary" 
                           Variant="Variant.Filled"
                           OnClick="ShowCreateProjectForm"
                           Title="Create Project" />
            
            @if (!string.IsNullOrEmpty(_selectedProject))
            {
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Color="Color.Secondary" 
                               Variant="Variant.Filled"
                               OnClick="ShowEditMetadataForm"
                               Title="Edit Project Metadata" />
                
                <MudButton StartIcon="@Icons.Material.Filled.Upload"
                           Color="Color.Primary"
                           Variant="Variant.Filled"
                           OnClick="@(() => _showUploadSection = true)">
                    Upload
                </MudButton>
            }
        </MudStack>
        
        @if (!string.IsNullOrEmpty(_selectedProject) && _selectedProjectInfo != null && !string.IsNullOrWhiteSpace(_selectedProjectInfo.Description))
        {
            <MudPaper Elevation="1" Class="pa-3 mb-4">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Color="Color.Default">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                        @_selectedProjectInfo.Description
                    </MudText>
                </MudStack>
            </MudPaper>
        }
        
        @if (!string.IsNullOrEmpty(_selectedProject))
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                <MudTextField @bind-Value="@_filter" 
                              Placeholder="Filter" 
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              IconSize="Size.Medium"
                              Margin="Margin.Dense"
                              DebounceInterval="300"
                              Style="max-width: 400px;">
                </MudTextField>
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                              OnClick="RefreshAsync" 
                              Size="Size.Small"
                              Title="Refresh file list" />
            </MudStack>
        }
        
        @if (_showCreateProjectForm)
        {
            <!-- Create Project Form -->
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.CreateNewFolder" Class="mr-2" />
                    Create New Project
                </MudText>
                <MudForm @ref="_createProjectForm" @bind-IsValid="_createProjectFormValid">
                    <MudTextField @bind-Value="_newProjectName" 
                                  Label="Project Name" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Project name is required"
                                  Validation="@(new Func<string, string>(ValidateProjectName))"
                                  Immediate="true"
                                  HelperText="Enter a unique name for the project. Use lowercase letters, numbers, and hyphens only."
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_newProjectType" 
                                  Label="Type (Optional)" 
                                  Variant="Variant.Outlined"
                                  HelperText="Specify the type or category of this project (e.g., Research, Analysis, Development)"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_newProjectDescription" 
                                  Label="Description (Optional)" 
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  HelperText="Provide a brief description of what this project contains"
                                  Class="mb-3" />
                </MudForm>
                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton OnClick="CancelCreateProject" 
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="CreateProjectAsync"
                               StartIcon="@Icons.Material.Filled.Check"
                               Disabled="@(!_createProjectFormValid || string.IsNullOrWhiteSpace(_newProjectName))">
                        Create Project
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        @if (_showEditMetadataForm)
        {
            <!-- Edit Project Metadata Form -->
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
                    Edit Project Metadata: @_selectedProject
                </MudText>
                <MudForm>
                    <MudTextField @bind-Value="_editProjectType" 
                                  Label="Type (Optional)" 
                                  Variant="Variant.Outlined"
                                  HelperText="Specify the type or category of this project (e.g., Research, Analysis, Development)"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_editProjectDescription" 
                                  Label="Description (Optional)" 
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  HelperText="Provide a brief description of what this project contains"
                                  Class="mb-3" />
                </MudForm>
                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton OnClick="CancelEditMetadata" 
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="UpdateProjectMetadataAsync"
                               StartIcon="@Icons.Material.Filled.Save">
                        Save Changes
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        @if (_showUploadSection)
        {
            <FileUploadSection TargetName="@_selectedProject"
                             MaxIndividualFileSize="MaxIndividualFileSize"
                             SelectedFiles="_fileUploads"
                             IsUploading="_isUploadingDocuments"
                             OnClose="@(() => _showUploadSection = false)"
                             OnUpload="SubmitFilesForUploadAsync" />
        }

        @if (!_projects.Any() && !_showCreateProjectForm && !_isLoadingProjects)
        {
            <MudAlert Severity="Severity.Info">No projects found. Create your first project to get started.</MudAlert>
        }
        else if (string.IsNullOrEmpty(_selectedProject) && _projects.Any() && !_showCreateProjectForm)
        {
            <MudAlert Severity="Severity.Info">
                <MudText Typo="Typo.h6">Select a project to continue</MudText>
                <MudText>Choose a project from the dropdown above to upload documents and view files.</MudText>
            </MudAlert>
        }
    </MudItem>
</MudGrid>

@if (!string.IsNullOrEmpty(_selectedProject))
{
    <br />

    <MudGrid>
        <!-- Project Files Table - Elevated -->
        <MudItem xs="12">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudTable Items="@_projectFiles" 
                              Dense="true" 
                              Hover="true" 
                              Bordered="true" 
                              FixedHeader="true" 
                              Filter="OnFileFilter" 
                              Elevation="0">
                        <HeaderContent>
                            <MudTh>File Name</MudTh>
                            <MudTh Style="width: 200px;">Processing Files</MudTh>
                            <MudTh Style="text-align: center; width: 200px;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    @if (CanViewFile(context.FileName))
                                    {
                                        <MudTooltip Text="View file">
                                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                           Color="Color.Info"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await ViewFileAsync(context.FileName, false))" />
                                        </MudTooltip>
                                    }
                                    <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" />
                                    <MudText>@context.FileName</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Processing Files">
                                @if (context.ProcessingFiles.Any())
                                {
                                    <MudStack Spacing="1">
                                        @foreach (var processingFile in context.ProcessingFiles)
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Description">
                                                    @Path.GetFileName(processingFile)
                                                </MudChip>
                                                @if (CanViewFile(processingFile))
                                                {
                                                    <MudTooltip Text="View file">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                                       Color="Color.Info"
                                                                       Size="Size.Small"
                                                                       OnClick="@(async () => await ViewFileAsync(processingFile, true))" />
                                                    </MudTooltip>
                                                }
                                            </MudStack>
                                        }
                                    </MudStack>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Default">
                                        <em>None</em>
                                    </MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Actions" Style="text-align: center;">
                                <MudStack Row="true" Justify="Justify.Center" Spacing="1">
                                    @if (_processingFiles.Contains(context.FileName))
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    }
                                    else if (_deletingFiles.Contains(context.FileName))
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Error" />
                                    }
                                    else
                                    {
                                        <MudTooltip Text="Process document layout">
                                            <MudIconButton Icon="@Icons.Material.Filled.AutoFixHigh"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await ProcessDocumentLayoutAsync(context.FileName))"
                                                           Title="Process Layout" />
                                        </MudTooltip>
                                        <MudTooltip Text="Delete file">
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Color="Color.Error"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await DeleteFileAsync(context.FileName))"
                                                           Title="Delete File" />
                                        </MudTooltip>
                                    }
                                </MudStack>
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                        </PagerContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}
