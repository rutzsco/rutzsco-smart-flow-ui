@page "/collections"
@using global::Shared.Models

<PageTitle>Collection Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pt-2 pb-6">
    <!-- Header Section -->
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-4">
        <MudText Typo="Typo.h5">Collection Management</MudText>
        <MudSpacer />
        
        @if (_isLoadingCollections)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            <MudText Typo="Typo.body2" Color="Color.Secondary">Loading...</MudText>
        }
        else if (_collections.Any())
        {
            @if (!string.IsNullOrEmpty(_selectedCollection))
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                    @_collectionFiles.Count file@(_collectionFiles.Count != 1 ? "s" : "")
                </MudChip>
                
                @if (_selectedCollectionInfo != null && !string.IsNullOrWhiteSpace(_selectedCollectionInfo.Type))
                {
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Color="Color.Info" 
                             Icon="@Icons.Material.Filled.Label"
                             Style="text-transform: uppercase;">
                        @_selectedCollectionInfo.Type
                    </MudChip>
                }
            }
            
            <MudMenu Label="@(_selectedCollection ?? "Select Collection")" Color="Color.Primary">
                <ActivatorContent>
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Outlined" 
                               StartIcon="@Icons.Material.Filled.Folder" 
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                        @(_selectedCollection ?? "Select Collection")
                    </MudButton>
                </ActivatorContent>
                <ChildContent>
                    @foreach (var collection in _collections)
                    {
                        <MudMenuItem OnClick="@(async () => await SelectCollectionAsync(collection.Name))">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body1">@collection.Name</MudText>
                                @if (!string.IsNullOrWhiteSpace(collection.Type))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Primary">Type: @collection.Type</MudText>
                                }
                                @if (!string.IsNullOrWhiteSpace(collection.Description))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default">@collection.Description</MudText>
                                }
                            </MudStack>
                        </MudMenuItem>
                    }
                </ChildContent>
            </MudMenu>
        }
        
        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                       Color="Color.Primary" 
                       Variant="Variant.Filled"
                       OnClick="ShowCreateCollectionForm"
                       Title="Create Collection" />
        
        @if (!string.IsNullOrEmpty(_selectedCollection))
        {
            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                           Color="Color.Default" 
                           Variant="Variant.Filled"
                           OnClick="ShowEditMetadataForm"
                           Title="Edit Collection Metadata" />
        }
    </MudStack>

    <!-- Description Banner (if available) -->
    @if (!string.IsNullOrEmpty(_selectedCollection) && _selectedCollectionInfo != null && !string.IsNullOrWhiteSpace(_selectedCollectionInfo.Description))
    {
        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
            @_selectedCollectionInfo.Description
        </MudAlert>
    }

    <!-- Create Collection Form -->
    @if (_showCreateCollectionForm)
    {
        <MudCard Elevation="1" Class="mb-4 rounded-lg">
            <MudCardContent Class="pa-6">
                <MudStack Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CreateNewFolder" Color="Color.Primary" />
                        <MudText Typo="Typo.h6">Create New Collection</MudText>
                    </MudStack>
                    
                    <MudForm @ref="_createCollectionForm" @bind-IsValid="_createCollectionFormValid">
                        <MudTextField @bind-Value="_newCollectionName" 
                                      Label="Collection Name" 
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Collection name is required"
                                      Validation="@(new Func<string, string>(ValidateCollectionName))"
                                      Immediate="true"
                                      HelperText="Enter a unique name for the collection. Use lowercase letters, numbers, and hyphens only."
                                      Class="mb-3" />
                        
                        <MudTextField @bind-Value="_newCollectionType" 
                                      Label="Type (Optional)" 
                                      Variant="Variant.Outlined"
                                      HelperText="Specify the type or category of this collection (e.g., Documents, Images, Reports)"
                                      Class="mb-3" />
                        
                        <MudSelect T="string" 
                                   @bind-Value="_newCollectionIndexName" 
                                   Label="Search Index (Optional)" 
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   HelperText="Associate this collection with an Azure AI Search index"
                                   Class="mb-3">
                            @foreach (var index in _availableIndexes.OrderBy(i => i.Name))
                            {
                                <MudSelectItem T="string" Value="@index.Name">@index.Name</MudSelectItem>
                            }
                        </MudSelect>
                        
                        <MudTextField @bind-Value="_newCollectionDescription" 
                                      Label="Description (Optional)" 
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      HelperText="Provide a brief description of what this collection contains"
                                      Class="mb-3" />
                    </MudForm>
                    
                    <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                        <MudButton OnClick="CancelCreateCollection" 
                                   Variant="Variant.Text">
                            Cancel
                        </MudButton>
                        <MudButton Color="Color.Primary" 
                                   Variant="Variant.Filled" 
                                   OnClick="CreateCollectionAsync"
                                   Disabled="@(!_createCollectionFormValid || string.IsNullOrWhiteSpace(_newCollectionName))">
                            Create Collection
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudCardContent>
        </MudCard>
    }

    <!-- Edit Collection Metadata Form -->
    @if (_showEditMetadataForm)
    {
        <MudCard Elevation="1" Class="mb-4 rounded-lg">
            <MudCardContent Class="pa-6">
                <MudStack Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" />
                        <MudText Typo="Typo.h6">Edit Collection Metadata</MudText>
                    </MudStack>
                    
                    <MudForm>
                        <MudTextField @bind-Value="_editCollectionType" 
                                      Label="Type (Optional)" 
                                      Variant="Variant.Outlined"
                                      HelperText="Specify the type or category of this collection"
                                      Class="mb-3" />
                        
                        <MudSelect T="string" 
                                   @bind-Value="_editCollectionIndexName" 
                                   Label="Search Index (Optional)" 
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   HelperText="Associate this collection with an Azure AI Search index"
                                   Class="mb-3">
                            @foreach (var index in _availableIndexes.OrderBy(i => i.Name))
                            {
                                <MudSelectItem T="string" Value="@index.Name">@index.Name</MudSelectItem>
                            }
                        </MudSelect>
                        
                        <MudTextField @bind-Value="_editCollectionDescription" 
                                      Label="Description (Optional)" 
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      HelperText="Provide a brief description of what this collection contains"
                                      Class="mb-3" />
                    </MudForm>
                    
                    <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                        <MudButton OnClick="CancelEditMetadata" 
                                   Variant="Variant.Text">
                            Cancel
                        </MudButton>
                        <MudButton Color="Color.Primary" 
                                   Variant="Variant.Filled" 
                                   OnClick="UpdateCollectionMetadataAsync">
                            Save Changes
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudCardContent>
        </MudCard>
    }

    <!-- Upload Section -->
    @if (_showUploadSection)
    {
        <FileUploadSection TargetName="@GetUploadTargetName()"
                         MaxIndividualFileSize="MaxIndividualFileSize"
                         SelectedFiles="_fileUploads"
                         IsUploading="_isUploadingDocuments"
                         FolderPath="@_currentFolderPath"
                         OnClose="@(() => _showUploadSection = false)"
                         OnUpload="SubmitFilesForUploadAsync" />
    }

    <!-- Empty State Messages -->
    @if (!_collections.Any() && !_showCreateCollectionForm && !_isLoadingCollections)
    {
        <MudAlert Severity="Severity.Info">No collections found. Create your first collection to get started.</MudAlert>
    }
    else if (string.IsNullOrEmpty(_selectedCollection) && _collections.Any() && !_showCreateCollectionForm)
    {
        <MudAlert Severity="Severity.Info">
            <MudText Typo="Typo.h6">Select a collection to continue</MudText>
            <MudText>Choose a collection from the dropdown above to upload documents and view files.</MudText>
        </MudAlert>
    }

    <!-- Collection Details -->
    @if (!string.IsNullOrEmpty(_selectedCollection))
    {
        <MudGrid>
            <!-- Folder Tree View -->
            <MudItem xs="12" md="3">
                <MudCard Elevation="1" Class="rounded-lg">
                    <MudCardContent Class="pa-4">
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.h6" Style="font-weight: 500;">
                                    <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Small" Class="mr-1" />
                                    Folders
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.CreateNewFolder" 
                                              Color="Color.Primary" 
                                              Size="Size.Small"
                                              OnClick="@(() => ShowCreateFolderDialogAsync(_selectedFolder))"
                                              Title="Create Folder" />
                            </MudStack>

                            @if (!string.IsNullOrEmpty(_currentFolderPath))
                            {
                                <MudChip T="string" 
                                         Icon="@Icons.Material.Filled.Folder" 
                                         Color="Color.Info" 
                                         Size="Size.Small">
                                    @_currentFolderPath
                                </MudChip>
                            }

                            <MudDivider />

                            <div Style="max-height: 500px; overflow-y: auto;">
                                @if (_folderStructure?.Children?.Any() == true)
                                {
                                    <FolderTreeView Items="@_folderStructure.Children"
                                                   SelectedNode="@_selectedFolder"
                                                   OnFolderSelected="@OnFolderSelectedAsync"
                                                   OnUploadDocuments="@((folder) => _showUploadSection = true)"
                                                   OnDeleteFolder="@DeleteFolderAsync"
                                                   ShowFolderActions="true" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="py-4">
                                        No folders yet. Click the + button above to create one.
                                    </MudText>
                                }
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Files Table -->
            <MudItem xs="12" md="9">
                <MudCard Elevation="1" Class="rounded-lg">
                    <MudCardContent Class="pa-4">
                        <MudStack Spacing="3">
                            <!-- Files Header with Search and Actions -->
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                    Files (@_collectionFiles.Count)
                                </MudText>
                                
                                <MudStack Row="true" Spacing="2">
                                    <MudTextField @bind-Value="@_filter" 
                                                  Placeholder="Filter files" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                                  Margin="Margin.Dense"
                                                  DebounceInterval="300"
                                                  Style="max-width: 300px;">
                                    </MudTextField>
                                    
                                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                                  Size="Size.Small"
                                                  OnClick="RefreshAsync"
                                                  Title="Refresh" />
                                    
                                    <MudButton StartIcon="@Icons.Material.Filled.Upload"
                                               Color="Color.Primary"
                                               Variant="Variant.Filled"
                                               Size="Size.Small"
                                               OnClick="@(() => _showUploadSection = true)">
                                        Upload
                                    </MudButton>
                                </MudStack>
                            </MudStack>

                            <MudDivider />

                            <!-- Files Table -->
                            @if (!_collectionFiles.Any())
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="py-4">
                                    No files uploaded yet. Upload a file to get started.
                                </MudText>
                            }
                            else
                            {
                                <MudTable Items="@GetFilteredFiles()" 
                                          Dense="true" 
                                          Hover="true" 
                                          Bordered="false" 
                                          FixedHeader="true" 
                                          Elevation="0">
                                    <HeaderContent>
                                        <MudTh>File Name</MudTh>
                                        <MudTh>Equipment Category</MudTh>
                                        <MudTh>Document Type</MudTh>
                                        <MudTh>Manufacturer</MudTh>
                                        <MudTh Style="text-align: center; width: 150px;">Actions</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Name">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                @if (CanViewFile(context.FileName))
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.RemoveRedEye"
                                                                   Size="Size.Small"
                                                                   OnClick="@(async () => await ViewFileAsync(context.FileName, false))"
                                                                   Title="View file"
                                                                   Style="color: #1976d2;" />
                                                }
                                                <MudText Typo="Typo.body2">@context.FileName</MudText>
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Equipment Category">
                                            <MudText Typo="Typo.body2">
                                                @(context.Metadata?.EquipmentCategory ?? "-")
                                            </MudText>
                                        </MudTd>
                                        <MudTd DataLabel="Document Type">
                                            <MudText Typo="Typo.body2">
                                                @(context.Metadata?.DocumentType ?? "-")
                                            </MudText>
                                        </MudTd>
                                        <MudTd DataLabel="Manufacturer">
                                            <MudText Typo="Typo.body2">
                                                @(context.Metadata?.Manufacturer ?? "-")
                                            </MudText>
                                        </MudTd>
                                        <MudTd DataLabel="Actions" Style="text-align: center;">
                                            <MudStack Row="true" Justify="Justify.Center" Spacing="1">
                                                @if (_processingFiles.Contains(context.FileName))
                                                {
                                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                                }
                                                else if (_deletingFiles.Contains(context.FileName))
                                                {
                                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Error" />
                                                }
                                                else
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.CloudSync"
                                                                   Color="Color.Primary"
                                                                   Size="Size.Small"
                                                                   OnClick="@(async () => await ProcessDocumentLayoutAsync(context.FileName))"
                                                                   Title="Index Document" />
                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                   Color="Color.Default"
                                                                   Size="Size.Small"
                                                                   OnClick="@(async () => await ShowEditFileMetadataDialogAsync(context))"
                                                                   Title="Edit Metadata" />
                                                }
                                            </MudStack>
                                        </MudTd>
                                    </RowTemplate>
                                    <PagerContent>
                                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                                    </PagerContent>
                                </MudTable>
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .rounded-lg {
        border-radius: 8px;
    }
</style>

@code {
    // Your existing code here...
}
