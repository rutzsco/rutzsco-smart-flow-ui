@using Microsoft.AspNetCore.Components.Forms

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.CloudUpload" />
        <MudText Typo="Typo.h6">Upload Documents to @TargetName</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                       OnClick="OnClose"
                       Title="Close upload section" />
    </MudStack>
    
    <MudFileUpload T="IReadOnlyList<IBrowserFile>" 
                   Accept=".pdf,.png,.jpg,.jpeg" 
                   MaximumFileCount="10" 
                   FilesChanged="OnFilesChanged" 
                   Required="true" 
                   RequiredError="You must select at least one file to upload.">
        <ActivatorContent>
            <MudButton HtmlTag="label"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.FileOpen"
                       Size="Size.Large">
                Select Files
            </MudButton>
        </ActivatorContent>
    </MudFileUpload>

    @if (SelectedFiles.Any())
    {
        <MudPaper Elevation="0" Class="mt-4 pa-3" Style="border: 1px dashed var(--mud-palette-primary);">
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                    @(SelectedFiles.Count) file(s) selected - @(SelectedFiles.Sum(f => f.Size).ToHumanReadableSize())
                </MudText>
                @foreach (var file in SelectedFiles)
                {
                    var fileSize = file.Size.ToHumanReadableSize();
                    var fileName = file.Name;
                    <MudChip T="string"
                             Icon="@Icons.Material.Filled.InsertDriveFile" 
                             OnClose="@(() => OnRemoveFile(file))">
                        @fileName (@fileSize)
                    </MudChip>
                }
            </MudStack>
        </MudPaper>
    }

    <MudText Typo="Typo.body2" Class="mt-3" Color="Color.Default">
        Maximum file size: @(MaxIndividualFileSize.ToHumanReadableSize()) | Accepted formats: PDF, PNG, JPG, JPEG
    </MudText>

    <MudStack Row="true" Spacing="2" Class="mt-4">
        @if (IsUploading)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            <MudText>Uploading documents...</MudText>
        }
        else
        {
            <MudButton StartIcon="@Icons.Material.Filled.Clear"
                       Variant="Variant.Text"
                       Color="Color.Default"
                       Disabled="@(!SelectedFiles.Any())"
                       OnClick="OnClearAll">
                Clear All
            </MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.Upload"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(!SelectedFiles.Any())"
                       OnClick="OnUpload">
                Upload @(SelectedFiles.Count) File@(SelectedFiles.Count != 1 ? "s" : "")
            </MudButton>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter, EditorRequired]
    public string TargetName { get; set; } = string.Empty;

    [Parameter]
    public long MaxIndividualFileSize { get; set; } = 1_024 * 1_024 * 10; // 10MB default

    [Parameter]
    public IList<IBrowserFile> SelectedFiles { get; set; } = new List<IBrowserFile>();

    [Parameter]
    public bool IsUploading { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<IReadOnlyList<IBrowserFile>> OnFilesSelected { get; set; }

    [Parameter]
    public EventCallback OnUpload { get; set; }

    private void OnFilesChanged(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            SelectedFiles.Add(file);
        }
        OnFilesSelected.InvokeAsync(files);
        StateHasChanged();
    }

    private void OnRemoveFile(IBrowserFile file)
    {
        SelectedFiles.Remove(file);
        StateHasChanged();
    }

    private void OnClearAll()
    {
        SelectedFiles.Clear();
        StateHasChanged();
    }
}
